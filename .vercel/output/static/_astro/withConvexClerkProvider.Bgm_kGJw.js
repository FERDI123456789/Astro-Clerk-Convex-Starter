import{j as w}from"./createLucideIcon.DJhnDDIa.js";import{d as se,a as ye,$ as Le,e as st,f as Ve}from"./chunk-5RWUYJKV.DT1PUBwP.js";import{r as g,R as m}from"./index.DeO6U63H.js";var A=[],R=[],rt=Uint8Array,re="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var E=0,it=re.length;E<it;++E)A[E]=re[E],R[re.charCodeAt(E)]=E;R[45]=62;R[95]=63;function ot(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}function at(n,e,t){return(e+t)*3/4-t}function W(n){var e,t=ot(n),s=t[0],r=t[1],i=new rt(at(n,s,r)),o=0,a=r>0?s-4:s,u;for(u=0;u<a;u+=4)e=R[n.charCodeAt(u)]<<18|R[n.charCodeAt(u+1)]<<12|R[n.charCodeAt(u+2)]<<6|R[n.charCodeAt(u+3)],i[o++]=e>>16&255,i[o++]=e>>8&255,i[o++]=e&255;return r===2&&(e=R[n.charCodeAt(u)]<<2|R[n.charCodeAt(u+1)]>>4,i[o++]=e&255),r===1&&(e=R[n.charCodeAt(u)]<<10|R[n.charCodeAt(u+1)]<<4|R[n.charCodeAt(u+2)]>>2,i[o++]=e>>8&255,i[o++]=e&255),i}function ut(n){return A[n>>18&63]+A[n>>12&63]+A[n>>6&63]+A[n&63]}function ct(n,e,t){for(var s,r=[],i=e;i<t;i+=3)s=(n[i]<<16&16711680)+(n[i+1]<<8&65280)+(n[i+2]&255),r.push(ut(s));return r.join("")}function H(n){for(var e,t=n.length,s=t%3,r=[],i=16383,o=0,a=t-s;o<a;o+=i)r.push(ct(n,o,o+i>a?a:o+i));return s===1?(e=n[t-1],r.push(A[e>>2]+A[e<<4&63]+"==")):s===2&&(e=(n[t-2]<<8)+n[t-1],r.push(A[e>>10]+A[e>>4&63]+A[e<<2&63]+"=")),r.join("")}function x(n){if(n===void 0)return{};if(!Fe(n))throw new Error(`The arguments to a Convex function must be an object. Received: ${n}`);return n}function ht(n){if(typeof n>"u")throw new Error("Client created with undefined deployment address. If you used an environment variable, check that it's set.");if(typeof n!="string")throw new Error(`Invalid deployment address: found ${n}".`);if(!(n.startsWith("http:")||n.startsWith("https:")))throw new Error(`Invalid deployment address: Must start with "https://" or "http://". Found "${n}".`);try{new URL(n)}catch{throw new Error(`Invalid deployment address: "${n}" is not a valid URL. If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}if(n.endsWith(".convex.site"))throw new Error(`Invalid deployment address: "${n}" ends with .convex.site, which is used for HTTP Actions. Convex deployment URLs typically end with .convex.cloud? If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}function Fe(n){const e=typeof n=="object",t=Object.getPrototypeOf(n),s=t===null||t===Object.prototype||t?.constructor?.name==="Object";return e&&s}const Ne=!0,L=BigInt("-9223372036854775808"),me=BigInt("9223372036854775807"),de=BigInt("0"),lt=BigInt("8"),dt=BigInt("256");function Be(n){return Number.isNaN(n)||!Number.isFinite(n)||Object.is(n,-0)}function ft(n){n<de&&(n-=L+L);let e=n.toString(16);e.length%2===1&&(e="0"+e);const t=new Uint8Array(new ArrayBuffer(8));let s=0;for(const r of e.match(/.{2}/g).reverse())t.set([parseInt(r,16)],s++),n>>=lt;return H(t)}function gt(n){const e=W(n);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);let t=de,s=de;for(const r of e)t+=BigInt(r)*dt**s,s++;return t>me&&(t+=L+L),t}function pt(n){if(n<L||me<n)throw new Error(`BigInt ${n} does not fit into a 64-bit signed integer.`);const e=new ArrayBuffer(8);return new DataView(e).setBigInt64(0,n,!0),H(new Uint8Array(e))}function yt(n){const e=W(n);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);return new DataView(e.buffer).getBigInt64(0,!0)}const mt=DataView.prototype.setBigInt64?pt:ft,wt=DataView.prototype.getBigInt64?yt:gt,ve=1024;function Ue(n){if(n.length>ve)throw new Error(`Field name ${n} exceeds maximum field name length ${ve}.`);if(n.startsWith("$"))throw new Error(`Field name ${n} starts with a '$', which is reserved.`);for(let e=0;e<n.length;e+=1){const t=n.charCodeAt(e);if(t<32||t>=127)throw new Error(`Field name ${n} has invalid character '${n[e]}': Field names can only contain non-control ASCII characters`)}}function V(n){if(n===null||typeof n=="boolean"||typeof n=="number"||typeof n=="string")return n;if(Array.isArray(n))return n.map(s=>V(s));if(typeof n!="object")throw new Error(`Unexpected type of ${n}`);const e=Object.entries(n);if(e.length===1){const s=e[0][0];if(s==="$bytes"){if(typeof n.$bytes!="string")throw new Error(`Malformed $bytes field on ${n}`);return W(n.$bytes).buffer}if(s==="$integer"){if(typeof n.$integer!="string")throw new Error(`Malformed $integer field on ${n}`);return wt(n.$integer)}if(s==="$float"){if(typeof n.$float!="string")throw new Error(`Malformed $float field on ${n}`);const r=W(n.$float);if(r.byteLength!==8)throw new Error(`Received ${r.byteLength} bytes, expected 8 for $float`);const o=new DataView(r.buffer).getFloat64(0,Ne);if(!Be(o))throw new Error(`Float ${o} should be encoded as a number`);return o}if(s==="$set")throw new Error("Received a Set which is no longer supported as a Convex type.");if(s==="$map")throw new Error("Received a Map which is no longer supported as a Convex type.")}const t={};for(const[s,r]of Object.entries(n))Ue(s),t[s]=V(r);return t}const ke=16384;function D(n){const e=JSON.stringify(n,(t,s)=>s===void 0?"undefined":typeof s=="bigint"?`${s.toString()}n`:s);if(e.length>ke){const t="[...truncated]";let s=ke-t.length;const r=e.codePointAt(s-1);return r!==void 0&&r>65535&&(s-=1),e.substring(0,s)+t}return e}function fe(n,e,t,s){if(n===void 0){const o=t&&` (present at path ${t} in original object ${D(e)})`;throw new Error(`undefined is not a valid Convex value${o}. To learn about Convex's supported types, see https://docs.convex.dev/using/types.`)}if(n===null)return n;if(typeof n=="bigint"){if(n<L||me<n)throw new Error(`BigInt ${n} does not fit into a 64-bit signed integer.`);return{$integer:mt(n)}}if(typeof n=="number")if(Be(n)){const o=new ArrayBuffer(8);return new DataView(o).setFloat64(0,n,Ne),{$float:H(new Uint8Array(o))}}else return n;if(typeof n=="boolean"||typeof n=="string")return n;if(n instanceof ArrayBuffer)return{$bytes:H(new Uint8Array(n))};if(Array.isArray(n))return n.map((o,a)=>fe(o,e,t+`[${a}]`));if(n instanceof Set)throw new Error(ie(t,"Set",[...n],e));if(n instanceof Map)throw new Error(ie(t,"Map",[...n],e));if(!Fe(n)){const o=n?.constructor?.name,a=o?`${o} `:"";throw new Error(ie(t,a,n,e))}const r={},i=Object.entries(n);i.sort(([o,a],[u,c])=>o===u?0:o<u?-1:1);for(const[o,a]of i)a!==void 0&&(Ue(o),r[o]=fe(a,e,t+`.${o}`));return r}function ie(n,e,t,s){return n?`${e}${D(t)} is not a supported Convex type (present at path ${n} in original object ${D(s)}). To learn about Convex's supported types, see https://docs.convex.dev/using/types.`:`${e}${D(t)} is not a supported Convex type.`}function _(n){return fe(n,n,"")}var St=Object.defineProperty,bt=(n,e,t)=>e in n?St(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,oe=(n,e,t)=>bt(n,typeof e!="symbol"?e+"":e,t),Ce,Re;const vt=Symbol.for("ConvexError");class ge extends(Re=Error,Ce=vt,Re){constructor(e){super(typeof e=="string"?e:D(e)),oe(this,"name","ConvexError"),oe(this,"data"),oe(this,Ce,!0),this.data=e}}const De=()=>Array.from({length:4},()=>0);De();De();const Te="1.31.7";var kt=Object.defineProperty,Ct=(n,e,t)=>e in n?kt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ae=(n,e,t)=>Ct(n,typeof e!="symbol"?e+"":e,t);const Rt="color:rgb(0, 145, 255)";function je(n){switch(n){case"query":return"Q";case"mutation":return"M";case"action":return"A";case"any":return"?"}}class We{constructor(e){Ae(this,"_onLogLineFuncs"),Ae(this,"_verbose"),this._onLogLineFuncs={},this._verbose=e.verbose}addLogLineListener(e){let t=Math.random().toString(36).substring(2,15);for(let s=0;s<10&&this._onLogLineFuncs[t]!==void 0;s++)t=Math.random().toString(36).substring(2,15);return this._onLogLineFuncs[t]=e,()=>{delete this._onLogLineFuncs[t]}}logVerbose(...e){if(this._verbose)for(const t of Object.values(this._onLogLineFuncs))t("debug",`${new Date().toISOString()}`,...e)}log(...e){for(const t of Object.values(this._onLogLineFuncs))t("info",...e)}warn(...e){for(const t of Object.values(this._onLogLineFuncs))t("warn",...e)}error(...e){for(const t of Object.values(this._onLogLineFuncs))t("error",...e)}}function He(n){const e=new We(n);return e.addLogLineListener((t,...s)=>{switch(t){case"debug":console.debug(...s);break;case"info":console.log(...s);break;case"warn":console.warn(...s);break;case"error":console.error(...s);break;default:console.log(...s)}}),e}function ze(n){return new We(n)}function ee(n,e,t,s,r){const i=je(t);if(typeof r=="object"&&(r=`ConvexError ${JSON.stringify(r.errorData,null,2)}`),e==="info"){const o=r.match(/^\[.*?\] /);if(o===null){n.error(`[CONVEX ${i}(${s})] Could not parse console.log`);return}const a=r.slice(1,o[0].length-2),u=r.slice(o[0].length);n.log(`%c[CONVEX ${i}(${s})] [${a}]`,Rt,u)}else n.error(`[CONVEX ${i}(${s})] ${r}`)}function Tt(n,e){const t=`[CONVEX FATAL ERROR] ${e}`;return n.error(t),new Error(t)}function Q(n,e,t){return`[CONVEX ${je(n)}(${e})] ${t.errorMessage}
  Called by client`}function pe(n,e){return e.data=n.errorData,e}function M(n){const e=n.split(":");let t,s;return e.length===1?(t=e[0],s="default"):(t=e.slice(0,e.length-1).join(":"),s=e[e.length-1]),t.endsWith(".js")&&(t=t.slice(0,-3)),`${t}:${s}`}function O(n,e){return JSON.stringify({udfPath:M(n),args:_(e)})}function _e(n,e,t){const{initialNumItems:s,id:r}=t;return JSON.stringify({type:"paginated",udfPath:M(n),args:_(e),options:_({initialNumItems:s,id:r})})}var At=Object.defineProperty,_t=(n,e,t)=>e in n?At(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,T=(n,e,t)=>_t(n,typeof e!="symbol"?e+"":e,t);class qt{constructor(){T(this,"nextQueryId"),T(this,"querySetVersion"),T(this,"querySet"),T(this,"queryIdToToken"),T(this,"identityVersion"),T(this,"auth"),T(this,"outstandingQueriesOlderThanRestart"),T(this,"outstandingAuthOlderThanRestart"),T(this,"paused"),T(this,"pendingQuerySetModifications"),this.nextQueryId=0,this.querySetVersion=0,this.identityVersion=0,this.querySet=new Map,this.queryIdToToken=new Map,this.outstandingQueriesOlderThanRestart=new Set,this.outstandingAuthOlderThanRestart=!1,this.paused=!1,this.pendingQuerySetModifications=new Map}hasSyncedPastLastReconnect(){return this.outstandingQueriesOlderThanRestart.size===0&&!this.outstandingAuthOlderThanRestart}markAuthCompletion(){this.outstandingAuthOlderThanRestart=!1}subscribe(e,t,s,r){const i=M(e),o=O(i,t),a=this.querySet.get(o);if(a!==void 0)return a.numSubscribers+=1,{queryToken:o,modification:null,unsubscribe:()=>this.removeSubscriber(o)};{const u=this.nextQueryId++,c={id:u,canonicalizedUdfPath:i,args:t,numSubscribers:1,journal:s,componentPath:r};this.querySet.set(o,c),this.queryIdToToken.set(u,o);const l=this.querySetVersion,f=this.querySetVersion+1,b={type:"Add",queryId:u,udfPath:i,args:[_(t)],journal:s,componentPath:r};return this.paused?this.pendingQuerySetModifications.set(u,b):this.querySetVersion=f,{queryToken:o,modification:{type:"ModifyQuerySet",baseVersion:l,newVersion:f,modifications:[b]},unsubscribe:()=>this.removeSubscriber(o)}}}transition(e){for(const t of e.modifications)switch(t.type){case"QueryUpdated":case"QueryFailed":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);const s=t.journal;if(s!==void 0){const r=this.queryIdToToken.get(t.queryId);r!==void 0&&(this.querySet.get(r).journal=s)}break}case"QueryRemoved":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);break}default:throw new Error(`Invalid modification ${t.type}`)}}queryId(e,t){const s=M(e),r=O(s,t),i=this.querySet.get(r);return i!==void 0?i.id:null}isCurrentOrNewerAuthVersion(e){return e>=this.identityVersion}getAuth(){return this.auth}setAuth(e){this.auth={tokenType:"User",value:e};const t=this.identityVersion;return this.paused||(this.identityVersion=t+1),{type:"Authenticate",baseVersion:t,...this.auth}}setAdminAuth(e,t){const s={tokenType:"Admin",value:e,impersonating:t};this.auth=s;const r=this.identityVersion;return this.paused||(this.identityVersion=r+1),{type:"Authenticate",baseVersion:r,...s}}clearAuth(){this.auth=void 0,this.markAuthCompletion();const e=this.identityVersion;return this.paused||(this.identityVersion=e+1),{type:"Authenticate",tokenType:"None",baseVersion:e}}hasAuth(){return!!this.auth}isNewAuth(e){return this.auth?.value!==e}queryPath(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).canonicalizedUdfPath:null}queryArgs(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).args:null}queryToken(e){return this.queryIdToToken.get(e)??null}queryJournal(e){return this.querySet.get(e)?.journal}restart(e){this.unpause(),this.outstandingQueriesOlderThanRestart.clear();const t=[];for(const i of this.querySet.values()){const o={type:"Add",queryId:i.id,udfPath:i.canonicalizedUdfPath,args:[_(i.args)],journal:i.journal,componentPath:i.componentPath};t.push(o),e.has(i.id)||this.outstandingQueriesOlderThanRestart.add(i.id)}this.querySetVersion=1;const s={type:"ModifyQuerySet",baseVersion:0,newVersion:1,modifications:t};if(!this.auth)return this.identityVersion=0,[s,void 0];this.outstandingAuthOlderThanRestart=!0;const r={type:"Authenticate",baseVersion:0,...this.auth};return this.identityVersion=1,[s,r]}pause(){this.paused=!0}resume(){const e=this.pendingQuerySetModifications.size>0?{type:"ModifyQuerySet",baseVersion:this.querySetVersion,newVersion:++this.querySetVersion,modifications:Array.from(this.pendingQuerySetModifications.values())}:void 0,t=this.auth!==void 0?{type:"Authenticate",baseVersion:this.identityVersion++,...this.auth}:void 0;return this.unpause(),[e,t]}unpause(){this.paused=!1,this.pendingQuerySetModifications.clear()}removeSubscriber(e){const t=this.querySet.get(e);if(t.numSubscribers>1)return t.numSubscribers-=1,null;{this.querySet.delete(e),this.queryIdToToken.delete(t.id),this.outstandingQueriesOlderThanRestart.delete(t.id);const s=this.querySetVersion,r=this.querySetVersion+1,i={type:"Remove",queryId:t.id};return this.paused?this.pendingQuerySetModifications.has(t.id)?this.pendingQuerySetModifications.delete(t.id):this.pendingQuerySetModifications.set(t.id,i):this.querySetVersion=r,{type:"ModifyQuerySet",baseVersion:s,newVersion:r,modifications:[i]}}}}var Pt=Object.defineProperty,xt=(n,e,t)=>e in n?Pt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,K=(n,e,t)=>xt(n,typeof e!="symbol"?e+"":e,t);class It{constructor(e,t){this.logger=e,this.markConnectionStateDirty=t,K(this,"inflightRequests"),K(this,"requestsOlderThanRestart"),K(this,"inflightMutationsCount",0),K(this,"inflightActionsCount",0),this.inflightRequests=new Map,this.requestsOlderThanRestart=new Set}request(e,t){const s=new Promise(r=>{const i=t?"Requested":"NotSent";this.inflightRequests.set(e.requestId,{message:e,status:{status:i,requestedAt:new Date,onResult:r}}),e.type==="Mutation"?this.inflightMutationsCount++:e.type==="Action"&&this.inflightActionsCount++});return this.markConnectionStateDirty(),s}onResponse(e){const t=this.inflightRequests.get(e.requestId);if(t===void 0||t.status.status==="Completed")return null;const s=t.message.type==="Mutation"?"mutation":"action",r=t.message.udfPath;for(const u of e.logLines)ee(this.logger,"info",s,r,u);const i=t.status;let o,a;if(e.success)o={success:!0,logLines:e.logLines,value:V(e.result)},a=()=>i.onResult(o);else{const u=e.result,{errorData:c}=e;ee(this.logger,"error",s,r,u),o={success:!1,errorMessage:u,errorData:c!==void 0?V(c):void 0,logLines:e.logLines},a=()=>i.onResult(o)}return e.type==="ActionResponse"||!e.success?(a(),this.inflightRequests.delete(e.requestId),this.requestsOlderThanRestart.delete(e.requestId),t.message.type==="Action"?this.inflightActionsCount--:t.message.type==="Mutation"&&this.inflightMutationsCount--,this.markConnectionStateDirty(),{requestId:e.requestId,result:o}):(t.status={status:"Completed",result:o,ts:e.ts,onResolve:a},null)}removeCompleted(e){const t=new Map;for(const[s,r]of this.inflightRequests.entries()){const i=r.status;i.status==="Completed"&&i.ts.lessThanOrEqual(e)&&(i.onResolve(),t.set(s,i.result),r.message.type==="Mutation"?this.inflightMutationsCount--:r.message.type==="Action"&&this.inflightActionsCount--,this.inflightRequests.delete(s),this.requestsOlderThanRestart.delete(s))}return t.size>0&&this.markConnectionStateDirty(),t}restart(){this.requestsOlderThanRestart=new Set(this.inflightRequests.keys());const e=[];for(const[t,s]of this.inflightRequests){if(s.status.status==="NotSent"){s.status.status="Requested",e.push(s.message);continue}if(s.message.type==="Mutation")e.push(s.message);else if(s.message.type==="Action"){if(this.inflightRequests.delete(t),this.requestsOlderThanRestart.delete(t),this.inflightActionsCount--,s.status.status==="Completed")throw new Error("Action should never be in 'Completed' state");s.status.onResult({success:!1,errorMessage:"Connection lost while action was in flight",logLines:[]})}}return this.markConnectionStateDirty(),e}resume(){const e=[];for(const[,t]of this.inflightRequests)if(t.status.status==="NotSent"){t.status.status="Requested",e.push(t.message);continue}return e}hasIncompleteRequests(){for(const e of this.inflightRequests.values())if(e.status.status==="Requested")return!0;return!1}hasInflightRequests(){return this.inflightRequests.size>0}hasSyncedPastLastReconnect(){return this.requestsOlderThanRestart.size===0}timeOfOldestInflightRequest(){if(this.inflightRequests.size===0)return null;let e=Date.now();for(const t of this.inflightRequests.values())t.status.status!=="Completed"&&t.status.requestedAt.getTime()<e&&(e=t.status.requestedAt.getTime());return new Date(e)}inflightMutations(){return this.inflightMutationsCount}inflightActions(){return this.inflightActionsCount}}const z=Symbol.for("functionName"),Je=Symbol.for("toReferencePath");function Ot(n){return n[Je]??null}function Mt(n){return n.startsWith("function://")}function Et(n){let e;if(typeof n=="string")Mt(n)?e={functionHandle:n}:e={name:n};else if(n[z])e={name:n[z]};else{const t=Ot(n);if(!t)throw new Error(`${n} is not a functionReference`);e={reference:t}}return e}function k(n){const e=Et(n);if(e.name===void 0)throw e.functionHandle!==void 0?new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received function handle ${e.functionHandle}`):e.reference!==void 0?new Error(`Expected function reference in the current component like "api.file.func" or "internal.file.func", but received reference ${e.reference}`):new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received ${JSON.stringify(e)}`);if(typeof n=="string")return n;const t=n[z];if(!t)throw new Error(`${n} is not a functionReference`);return t}function Ke(n){return{[z]:n}}function Ge(n=[]){const e={get(t,s){if(typeof s=="string"){const r=[...n,s];return Ge(r)}else if(s===z){if(n.length<2){const o=["api",...n].join(".");throw new Error(`API path is expected to be of the form \`api.moduleName.functionName\`. Found: \`${o}\``)}const r=n.slice(0,-1).join("/"),i=n[n.length-1];return i==="default"?r:r+":"+i}else return s===Symbol.toStringTag?"FunctionReference":void 0}};return new Proxy({},e)}const $t=Ge();var Qt=Object.defineProperty,Lt=(n,e,t)=>e in n?Qt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,te=(n,e,t)=>Lt(n,typeof e!="symbol"?e+"":e,t);class J{constructor(e){te(this,"queryResults"),te(this,"modifiedQueries"),this.queryResults=e,this.modifiedQueries=[]}getQuery(e,...t){const s=x(t[0]),r=k(e),i=this.queryResults.get(O(r,s));if(i!==void 0)return J.queryValue(i.result)}getAllQueries(e){const t=[],s=k(e);for(const r of this.queryResults.values())r.udfPath===M(s)&&t.push({args:r.args,value:J.queryValue(r.result)});return t}setQuery(e,t,s){const r=x(t),i=k(e),o=O(i,r);let a;s===void 0?a=void 0:a={success:!0,value:s,logLines:[]};const u={udfPath:i,args:r,result:a};this.queryResults.set(o,u),this.modifiedQueries.push(o)}static queryValue(e){if(e!==void 0)return e.success?e.value:void 0}}class Vt{constructor(){te(this,"queryResults"),te(this,"optimisticUpdates"),this.queryResults=new Map,this.optimisticUpdates=[]}ingestQueryResultsFromServer(e,t){this.optimisticUpdates=this.optimisticUpdates.filter(o=>!t.has(o.mutationId));const s=this.queryResults;this.queryResults=new Map(e);const r=new J(this.queryResults);for(const o of this.optimisticUpdates)o.update(r);const i=[];for(const[o,a]of this.queryResults){const u=s.get(o);(u===void 0||u.result!==a.result)&&i.push(o)}return i}applyOptimisticUpdate(e,t){this.optimisticUpdates.push({update:e,mutationId:t});const s=new J(this.queryResults);return e(s),s.modifiedQueries}rawQueryResult(e){const t=this.queryResults.get(e);if(t!==void 0)return t.result}queryResult(e){const t=this.queryResults.get(e);if(t===void 0)return;const s=t.result;if(s!==void 0){if(s.success)return s.value;throw s.errorData!==void 0?pe(s,new ge(Q("query",t.udfPath,s))):new Error(Q("query",t.udfPath,s))}}hasQueryResult(e){return this.queryResults.get(e)!==void 0}queryLogs(e){return this.queryResults.get(e)?.result?.logLines}}var Ft=Object.defineProperty,Nt=(n,e,t)=>e in n?Ft(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ae=(n,e,t)=>Nt(n,typeof e!="symbol"?e+"":e,t);class v{constructor(e,t){ae(this,"low"),ae(this,"high"),ae(this,"__isUnsignedLong__"),this.low=e|0,this.high=t|0,this.__isUnsignedLong__=!0}static isLong(e){return(e&&e.__isUnsignedLong__)===!0}static fromBytesLE(e){return new v(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24)}toBytesLE(){const e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]}static fromNumber(e){return isNaN(e)||e<0?qe:e>=Bt?Ut:new v(e%j|0,e/j|0)}toString(){return(BigInt(this.high)*BigInt(j)+BigInt(this.low)).toString()}equals(e){return v.isLong(e)||(e=v.fromValue(e)),this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low}notEquals(e){return!this.equals(e)}comp(e){return v.isLong(e)||(e=v.fromValue(e)),this.equals(e)?0:e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1}lessThanOrEqual(e){return this.comp(e)<=0}static fromValue(e){return typeof e=="number"?v.fromNumber(e):new v(e.low,e.high)}}const qe=new v(0,0),Pe=65536,j=Pe*Pe,Bt=j*j,Ut=new v(-1,-1);var Dt=Object.defineProperty,jt=(n,e,t)=>e in n?Dt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,G=(n,e,t)=>jt(n,typeof e!="symbol"?e+"":e,t);class xe{constructor(e,t){G(this,"version"),G(this,"remoteQuerySet"),G(this,"queryPath"),G(this,"logger"),this.version={querySet:0,ts:v.fromNumber(0),identity:0},this.remoteQuerySet=new Map,this.queryPath=e,this.logger=t}transition(e){const t=e.startVersion;if(this.version.querySet!==t.querySet||this.version.ts.notEquals(t.ts)||this.version.identity!==t.identity)throw new Error(`Invalid start version: ${t.ts.toString()}:${t.querySet}:${t.identity}, transitioning from ${this.version.ts.toString()}:${this.version.querySet}:${this.version.identity}`);for(const s of e.modifications)switch(s.type){case"QueryUpdated":{const r=this.queryPath(s.queryId);if(r)for(const o of s.logLines)ee(this.logger,"info","query",r,o);const i=V(s.value??null);this.remoteQuerySet.set(s.queryId,{success:!0,value:i,logLines:s.logLines});break}case"QueryFailed":{const r=this.queryPath(s.queryId);if(r)for(const o of s.logLines)ee(this.logger,"info","query",r,o);const{errorData:i}=s;this.remoteQuerySet.set(s.queryId,{success:!1,errorMessage:s.errorMessage,errorData:i!==void 0?V(i):void 0,logLines:s.logLines});break}case"QueryRemoved":{this.remoteQuerySet.delete(s.queryId);break}default:throw new Error(`Invalid modification ${s.type}`)}this.version=e.endVersion}remoteQueryResults(){return this.remoteQuerySet}timestamp(){return this.version.ts}}function ue(n){const e=W(n);return v.fromBytesLE(Array.from(e))}function Wt(n){const e=new Uint8Array(n.toBytesLE());return H(e)}function Ie(n){switch(n.type){case"FatalError":case"AuthError":case"ActionResponse":case"TransitionChunk":case"Ping":return{...n};case"MutationResponse":return n.success?{...n,ts:ue(n.ts)}:{...n};case"Transition":return{...n,startVersion:{...n.startVersion,ts:ue(n.startVersion.ts)},endVersion:{...n.endVersion,ts:ue(n.endVersion.ts)}}}}function Ht(n){switch(n.type){case"Authenticate":case"ModifyQuerySet":case"Mutation":case"Action":case"Event":return{...n};case"Connect":return n.maxObservedTimestamp!==void 0?{...n,maxObservedTimestamp:Wt(n.maxObservedTimestamp)}:{...n,maxObservedTimestamp:void 0}}}var zt=Object.defineProperty,Jt=(n,e,t)=>e in n?zt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,p=(n,e,t)=>Jt(n,typeof e!="symbol"?e+"":e,t);const Kt=1e3,Gt=1001,Xt=1005,Yt=4040;let Z;function $(){return Z===void 0&&(Z=Date.now()),typeof performance>"u"||!performance.now?Date.now():Math.round(Z+performance.now())}function Oe(){return`t=${Math.round(($()-Z)/100)/10}s`}const Xe={InternalServerError:{timeout:1e3},SubscriptionsWorkerFullError:{timeout:3e3},TooManyConcurrentRequests:{timeout:3e3},CommitterFullError:{timeout:3e3},AwsTooManyRequestsException:{timeout:3e3},ExecuteFullError:{timeout:3e3},SystemTimeoutError:{timeout:3e3},ExpiredInQueue:{timeout:3e3},VectorIndexesUnavailable:{timeout:1e3},SearchIndexesUnavailable:{timeout:1e3},TableSummariesUnavailable:{timeout:1e3},VectorIndexTooLarge:{timeout:3e3},SearchIndexTooLarge:{timeout:3e3},TooManyWritesInTimePeriod:{timeout:3e3}};function Zt(n){if(n===void 0)return"Unknown";for(const e of Object.keys(Xe))if(n.startsWith(e))return e;return"Unknown"}class en{constructor(e,t,s,r,i,o){this.markConnectionStateDirty=i,this.debug=o,p(this,"socket"),p(this,"connectionCount"),p(this,"_hasEverConnected",!1),p(this,"lastCloseReason"),p(this,"transitionChunkBuffer",null),p(this,"defaultInitialBackoff"),p(this,"maxBackoff"),p(this,"retries"),p(this,"serverInactivityThreshold"),p(this,"reconnectDueToServerInactivityTimeout"),p(this,"scheduledReconnect",null),p(this,"networkOnlineHandler",null),p(this,"pendingNetworkRecoveryInfo",null),p(this,"uri"),p(this,"onOpen"),p(this,"onResume"),p(this,"onMessage"),p(this,"webSocketConstructor"),p(this,"logger"),p(this,"onServerDisconnectError"),this.webSocketConstructor=s,this.socket={state:"disconnected"},this.connectionCount=0,this.lastCloseReason="InitialConnect",this.defaultInitialBackoff=1e3,this.maxBackoff=16e3,this.retries=0,this.serverInactivityThreshold=6e4,this.reconnectDueToServerInactivityTimeout=null,this.uri=e,this.onOpen=t.onOpen,this.onResume=t.onResume,this.onMessage=t.onMessage,this.onServerDisconnectError=t.onServerDisconnectError,this.logger=r,this.setupNetworkListener(),this.connect()}setSocketState(e){this.socket=e,this._logVerbose(`socket state changed: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}`),this.markConnectionStateDirty()}setupNetworkListener(){typeof window>"u"||typeof window.addEventListener!="function"||this.networkOnlineHandler===null&&(this.networkOnlineHandler=()=>{this._logVerbose("network online event detected"),this.tryReconnectImmediately()},window.addEventListener("online",this.networkOnlineHandler),this._logVerbose("network online event listener registered"))}cleanupNetworkListener(){this.networkOnlineHandler&&typeof window<"u"&&typeof window.removeEventListener=="function"&&(window.removeEventListener("online",this.networkOnlineHandler),this.networkOnlineHandler=null,this._logVerbose("network online event listener removed"))}assembleTransition(e){if(e.partNumber<0||e.partNumber>=e.totalParts||e.totalParts===0||this.transitionChunkBuffer&&(this.transitionChunkBuffer.totalParts!==e.totalParts||this.transitionChunkBuffer.transitionId!==e.transitionId))throw this.transitionChunkBuffer=null,new Error("Invalid TransitionChunk");if(this.transitionChunkBuffer===null&&(this.transitionChunkBuffer={chunks:[],totalParts:e.totalParts,transitionId:e.transitionId}),e.partNumber!==this.transitionChunkBuffer.chunks.length){const t=this.transitionChunkBuffer.chunks.length;throw this.transitionChunkBuffer=null,new Error(`TransitionChunk received out of order: expected part ${t}, got ${e.partNumber}`)}if(this.transitionChunkBuffer.chunks.push(e.chunk),this.transitionChunkBuffer.chunks.length===e.totalParts){const t=this.transitionChunkBuffer.chunks.join("");this.transitionChunkBuffer=null;const s=Ie(JSON.parse(t));if(s.type!=="Transition")throw new Error(`Expected Transition, got ${s.type} after assembling chunks`);return s}return null}connect(){if(this.socket.state==="terminated")return;if(this.socket.state!=="disconnected"&&this.socket.state!=="stopped")throw new Error("Didn't start connection from disconnected state: "+this.socket.state);const e=new this.webSocketConstructor(this.uri);this._logVerbose("constructed WebSocket"),this.setSocketState({state:"connecting",ws:e,paused:"no"}),this.resetServerInactivityTimeout(),e.onopen=()=>{if(this.logger.logVerbose("begin ws.onopen"),this.socket.state!=="connecting")throw new Error("onopen called with socket not in connecting state");if(this.setSocketState({state:"ready",ws:e,paused:this.socket.paused==="yes"?"uninitialized":"no"}),this.resetServerInactivityTimeout(),this.socket.paused==="no"&&(this._hasEverConnected=!0,this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:$()})),this.lastCloseReason!=="InitialConnect"&&(this.lastCloseReason?this.logger.log("WebSocket reconnected at",Oe(),"after disconnect due to",this.lastCloseReason):this.logger.log("WebSocket reconnected at",Oe())),this.connectionCount+=1,this.lastCloseReason=null,this.pendingNetworkRecoveryInfo!==null){const{timeSavedMs:t}=this.pendingNetworkRecoveryInfo;this.pendingNetworkRecoveryInfo=null,this.sendMessage({type:"Event",eventType:"NetworkRecoveryReconnect",event:{timeSavedMs:t}}),this.logger.log(`Network recovery reconnect saved ~${Math.round(t/1e3)}s of waiting`)}},e.onerror=t=>{this.transitionChunkBuffer=null;const s=t.message;s&&this.logger.log(`WebSocket error message: ${s}`)},e.onmessage=t=>{this.resetServerInactivityTimeout();const s=t.data.length;let r=Ie(JSON.parse(t.data));if(this._logVerbose(`received ws message with type ${r.type}`),r.type==="Ping")return;if(r.type==="TransitionChunk"){const o=this.assembleTransition(r);if(!o)return;r=o,this._logVerbose(`assembled full ws message of type ${r.type}`)}this.transitionChunkBuffer!==null&&(this.transitionChunkBuffer=null,this.logger.log(`Received unexpected ${r.type} while buffering TransitionChunks`)),r.type==="Transition"&&this.reportLargeTransition({messageLength:s,transition:r}),this.onMessage(r).hasSyncedPastLastReconnect&&(this.retries=0,this.markConnectionStateDirty())},e.onclose=t=>{if(this._logVerbose("begin ws.onclose"),this.transitionChunkBuffer=null,this.lastCloseReason===null&&(this.lastCloseReason=t.reason||`closed with code ${t.code}`),t.code!==Kt&&t.code!==Gt&&t.code!==Xt&&t.code!==Yt){let r=`WebSocket closed with code ${t.code}`;t.reason&&(r+=`: ${t.reason}`),this.logger.log(r),this.onServerDisconnectError&&t.reason&&this.onServerDisconnectError(r)}const s=Zt(t.reason);this.scheduleReconnect(s)}}socketState(){return this.socket.state}sendMessage(e){const t={type:e.type,...e.type==="Authenticate"&&e.tokenType==="User"?{value:`...${e.value.slice(-7)}`}:{}};if(this.socket.state==="ready"&&this.socket.paused==="no"){const s=Ht(e),r=JSON.stringify(s);let i=!1;try{this.socket.ws.send(r),i=!0}catch(o){this.logger.log(`Failed to send message on WebSocket, reconnecting: ${o}`),this.closeAndReconnect("FailedToSendMessage")}return this._logVerbose(`${i?"sent":"failed to send"} message with type ${e.type}: ${JSON.stringify(t)}`),!0}return this._logVerbose(`message not sent (socket state: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}): ${JSON.stringify(t)}`),!1}resetServerInactivityTimeout(){this.socket.state!=="terminated"&&(this.reconnectDueToServerInactivityTimeout!==null&&(clearTimeout(this.reconnectDueToServerInactivityTimeout),this.reconnectDueToServerInactivityTimeout=null),this.reconnectDueToServerInactivityTimeout=setTimeout(()=>{this.closeAndReconnect("InactiveServer")},this.serverInactivityThreshold))}scheduleReconnect(e){this.scheduledReconnect&&(clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null),this.socket={state:"disconnected"};const t=this.nextBackoff(e);this.markConnectionStateDirty(),this.logger.log(`Attempting reconnect in ${Math.round(t)}ms`);const s=$(),r=setTimeout(()=>{this.scheduledReconnect?.timeout===r&&(this.scheduledReconnect=null,this.connect())},t);this.scheduledReconnect={timeout:r,scheduledAt:s,backoffMs:t}}closeAndReconnect(e){switch(this._logVerbose(`begin closeAndReconnect with reason ${e}`),this.socket.state){case"disconnected":case"terminated":case"stopped":return;case"connecting":case"ready":{this.lastCloseReason=e,this.close(),this.scheduleReconnect("client");return}default:this.socket}}close(){switch(this.transitionChunkBuffer=null,this.socket.state){case"disconnected":case"terminated":case"stopped":return Promise.resolve();case"connecting":{const e=this.socket.ws;return e.onmessage=t=>{this._logVerbose("Ignoring message received after close")},new Promise(t=>{e.onclose=()=>{this._logVerbose("Closed after connecting"),t()},e.onopen=()=>{this._logVerbose("Opened after connecting"),e.close()}})}case"ready":{this._logVerbose("ws.close called");const e=this.socket.ws;e.onmessage=s=>{this._logVerbose("Ignoring message received after close")};const t=new Promise(s=>{e.onclose=()=>{s()}});return e.close(),t}default:return this.socket,Promise.resolve()}}terminate(){switch(this.reconnectDueToServerInactivityTimeout&&clearTimeout(this.reconnectDueToServerInactivityTimeout),this.scheduledReconnect&&(clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null),this.cleanupNetworkListener(),this.socket.state){case"terminated":case"stopped":case"disconnected":case"connecting":case"ready":{const e=this.close();return this.setSocketState({state:"terminated"}),e}default:throw this.socket,new Error(`Invalid websocket state: ${this.socket.state}`)}}stop(){switch(this.socket.state){case"terminated":return Promise.resolve();case"connecting":case"stopped":case"disconnected":case"ready":{this.cleanupNetworkListener();const e=this.close();return this.socket={state:"stopped"},e}default:return this.socket,Promise.resolve()}}tryRestart(){switch(this.socket.state){case"stopped":break;case"terminated":case"connecting":case"ready":case"disconnected":this.logger.logVerbose("Restart called without stopping first");return;default:this.socket}this.setupNetworkListener(),this.connect()}pause(){switch(this.socket.state){case"disconnected":case"stopped":case"terminated":return;case"connecting":case"ready":{this.socket={...this.socket,paused:"yes"};return}default:{this.socket;return}}}tryReconnectImmediately(){if(this._logVerbose("tryReconnectImmediately called"),this.socket.state!=="disconnected"){this._logVerbose(`tryReconnectImmediately called but socket state is ${this.socket.state}, no action taken`);return}let e=null;if(this.scheduledReconnect){const t=$()-this.scheduledReconnect.scheduledAt;e=Math.max(0,this.scheduledReconnect.backoffMs-t),this._logVerbose(`would have waited ${Math.round(e)}ms more (backoff was ${Math.round(this.scheduledReconnect.backoffMs)}ms, elapsed ${Math.round(t)}ms)`),clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null,this._logVerbose("canceled scheduled reconnect")}this.logger.log("Network recovery detected, reconnecting immediately"),this.pendingNetworkRecoveryInfo=e!==null?{timeSavedMs:e}:null,this.connect()}resume(){switch(this.socket.state){case"connecting":this.socket={...this.socket,paused:"no"};return;case"ready":this.socket.paused==="uninitialized"?(this.socket={...this.socket,paused:"no"},this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:$()})):this.socket.paused==="yes"&&(this.socket={...this.socket,paused:"no"},this.onResume());return;case"terminated":case"stopped":case"disconnected":return;default:this.socket}this.connect()}connectionState(){return{isConnected:this.socket.state==="ready",hasEverConnected:this._hasEverConnected,connectionCount:this.connectionCount,connectionRetries:this.retries}}_logVerbose(e){this.logger.logVerbose(e)}nextBackoff(e){const s=(e==="client"?100:e==="Unknown"?this.defaultInitialBackoff:Xe[e].timeout)*Math.pow(2,this.retries);this.retries+=1;const r=Math.min(s,this.maxBackoff),i=r*(Math.random()-.5);return r+i}reportLargeTransition({transition:e,messageLength:t}){if(e.clientClockSkew===void 0||e.serverTs===void 0)return;const s=$()-e.clientClockSkew-e.serverTs/1e6,r=`${Math.round(s)}ms`,i=`${Math.round(t/1e4)/100}MB`,o=t/(s/1e3),a=`${Math.round(o/1e4)/100}MB per second`;this._logVerbose(`received ${i} transition in ${r} at ${a}`),t>2e7?this.logger.log(`received query results totaling more that 20MB (${i}) which will take a long time to download on slower connections`):s>2e4&&this.logger.log(`received query results totaling ${i} which took more than 20s to arrive (${r})`),this.debug&&this.sendMessage({type:"Event",eventType:"ClientReceivedTransition",event:{transitionTransitTime:s,messageLength:t}})}}function tn(){return nn()}function nn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}class U extends Error{}U.prototype.name="InvalidTokenError";function sn(n){return decodeURIComponent(atob(n).replace(/(.)/g,(e,t)=>{let s=t.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}function rn(n){let e=n.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return sn(e)}catch{return atob(e)}}function Ye(n,e){if(typeof n!="string")throw new U("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,s=n.split(".")[t];if(typeof s!="string")throw new U(`Invalid token specified: missing part #${t+1}`);let r;try{r=rn(s)}catch(i){throw new U(`Invalid token specified: invalid base64 for part #${t+1} (${i.message})`)}try{return JSON.parse(r)}catch(i){throw new U(`Invalid token specified: invalid json for part #${t+1} (${i.message})`)}}var on=Object.defineProperty,an=(n,e,t)=>e in n?on(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,C=(n,e,t)=>an(n,typeof e!="symbol"?e+"":e,t);const un=480*60*60*1e3,Me=2;class cn{constructor(e,t,s){C(this,"authState",{state:"noAuth"}),C(this,"configVersion",0),C(this,"syncState"),C(this,"authenticate"),C(this,"stopSocket"),C(this,"tryRestartSocket"),C(this,"pauseSocket"),C(this,"resumeSocket"),C(this,"clearAuth"),C(this,"logger"),C(this,"refreshTokenLeewaySeconds"),C(this,"tokenConfirmationAttempts",0),this.syncState=e,this.authenticate=t.authenticate,this.stopSocket=t.stopSocket,this.tryRestartSocket=t.tryRestartSocket,this.pauseSocket=t.pauseSocket,this.resumeSocket=t.resumeSocket,this.clearAuth=t.clearAuth,this.logger=s.logger,this.refreshTokenLeewaySeconds=s.refreshTokenLeewaySeconds}async setConfig(e,t){this.resetAuthState(),this._logVerbose("pausing WS for auth token fetch"),this.pauseSocket();const s=await this.fetchTokenAndGuardAgainstRace(e,{forceRefreshToken:!1});s.isFromOutdatedConfig||(s.value?(this.setAuthState({state:"waitingForServerConfirmationOfCachedToken",config:{fetchToken:e,onAuthChange:t},hasRetried:!1}),this.authenticate(s.value)):(this.setAuthState({state:"initialRefetch",config:{fetchToken:e,onAuthChange:t}}),await this.refetchToken()),this._logVerbose("resuming WS after auth token fetch"),this.resumeSocket())}onTransition(e){if(this.syncState.isCurrentOrNewerAuthVersion(e.endVersion.identity)&&!(e.endVersion.identity<=e.startVersion.identity)){if(this.authState.state==="waitingForServerConfirmationOfCachedToken"){this._logVerbose("server confirmed auth token is valid"),this.refetchToken(),this.authState.config.onAuthChange(!0);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this._logVerbose("server confirmed new auth token is valid"),this.scheduleTokenRefetch(this.authState.token),this.tokenConfirmationAttempts=0,this.authState.hadAuth||this.authState.config.onAuthChange(!0))}}onAuthError(e){if(e.authUpdateAttempted===!1&&(this.authState.state==="waitingForServerConfirmationOfFreshToken"||this.authState.state==="waitingForServerConfirmationOfCachedToken")){this._logVerbose("ignoring non-auth token expired error");return}const{baseVersion:t}=e;if(!this.syncState.isCurrentOrNewerAuthVersion(t+1)){this._logVerbose("ignoring auth error for previous auth attempt");return}this.tryToReauthenticate(e)}async tryToReauthenticate(e){if(this._logVerbose(`attempting to reauthenticate: ${e.error}`),this.authState.state==="noAuth"||this.authState.state==="waitingForServerConfirmationOfFreshToken"&&this.tokenConfirmationAttempts>=Me){this.logger.error(`Failed to authenticate: "${e.error}", check your server auth config`),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.authState.state!=="noAuth"&&this.setAndReportAuthFailed(this.authState.config.onAuthChange);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this.tokenConfirmationAttempts++,this._logVerbose(`retrying reauthentication, ${Me-this.tokenConfirmationAttempts} attempts remaining`)),await this.stopSocket();const t=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});t.isFromOutdatedConfig||(t.value&&this.syncState.isNewAuth(t.value)?(this.authenticate(t.value),this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",config:this.authState.config,token:t.value,hadAuth:this.authState.state==="notRefetching"||this.authState.state==="waitingForScheduledRefetch"})):(this._logVerbose("reauthentication failed, could not fetch a new token"),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this.tryRestartSocket())}async refetchToken(){if(this.authState.state==="noAuth")return;this._logVerbose("refetching auth token");const e=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});e.isFromOutdatedConfig||(e.value?this.syncState.isNewAuth(e.value)?(this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",hadAuth:this.syncState.hasAuth(),token:e.value,config:this.authState.config}),this.authenticate(e.value)):this.setAuthState({state:"notRefetching",config:this.authState.config}):(this._logVerbose("refetching token failed"),this.syncState.hasAuth()&&this.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this._logVerbose("restarting WS after auth token fetch (if currently stopped)"),this.tryRestartSocket())}scheduleTokenRefetch(e){if(this.authState.state==="noAuth")return;const t=this.decodeToken(e);if(!t){this.logger.error("Auth token is not a valid JWT, cannot refetch the token");return}const{iat:s,exp:r}=t;if(!s||!r){this.logger.error("Auth token does not have required fields, cannot refetch the token");return}const i=r-s;if(i<=2){this.logger.error("Auth token does not live long enough, cannot refetch the token");return}let o=Math.min(un,(i-this.refreshTokenLeewaySeconds)*1e3);o<=0&&(this.logger.warn(`Refetching auth token immediately, configured leeway ${this.refreshTokenLeewaySeconds}s is larger than the token's lifetime ${i}s`),o=0);const a=setTimeout(()=>{this._logVerbose("running scheduled token refetch"),this.refetchToken()},o);this.setAuthState({state:"waitingForScheduledRefetch",refetchTokenTimeoutId:a,config:this.authState.config}),this._logVerbose(`scheduled preemptive auth token refetching in ${o}ms`)}async fetchTokenAndGuardAgainstRace(e,t){const s=++this.configVersion;this._logVerbose(`fetching token with config version ${s}`);const r=await e(t);return this.configVersion!==s?(this._logVerbose(`stale config version, expected ${s}, got ${this.configVersion}`),{isFromOutdatedConfig:!0}):{isFromOutdatedConfig:!1,value:r}}stop(){this.resetAuthState(),this.configVersion++,this._logVerbose(`config version bumped to ${this.configVersion}`)}setAndReportAuthFailed(e){e(!1),this.resetAuthState()}resetAuthState(){this.setAuthState({state:"noAuth"})}setAuthState(e){const t=e.state==="waitingForServerConfirmationOfFreshToken"?{hadAuth:e.hadAuth,state:e.state,token:`...${e.token.slice(-7)}`}:{state:e.state};switch(this._logVerbose(`setting auth state to ${JSON.stringify(t)}`),e.state){case"waitingForScheduledRefetch":case"notRefetching":case"noAuth":this.tokenConfirmationAttempts=0;break}this.authState.state==="waitingForScheduledRefetch"&&(clearTimeout(this.authState.refetchTokenTimeoutId),this.syncState.markAuthCompletion()),this.authState=e}decodeToken(e){try{return Ye(e)}catch(t){return this._logVerbose(`Error decoding token: ${t instanceof Error?t.message:"Unknown error"}`),null}}_logVerbose(e){this.logger.logVerbose(`${e} [v${this.configVersion}]`)}}const hn=["convexClientConstructed","convexWebSocketOpen","convexFirstMessageReceived"];function ln(n,e){const t={sessionId:e};typeof performance>"u"||!performance.mark||performance.mark(n,{detail:t})}function dn(n){let e=n.name.slice(6);return e=e.charAt(0).toLowerCase()+e.slice(1),{name:e,startTime:n.startTime}}function fn(n){if(typeof performance>"u"||!performance.getEntriesByName)return[];const e=[];for(const t of hn){const s=performance.getEntriesByName(t).filter(r=>r.entryType==="mark").filter(r=>r.detail.sessionId===n);e.push(...s)}return e.map(dn)}var gn=Object.defineProperty,pn=(n,e,t)=>e in n?gn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,y=(n,e,t)=>pn(n,typeof e!="symbol"?e+"":e,t);class yn{constructor(e,t,s){if(y(this,"address"),y(this,"state"),y(this,"requestManager"),y(this,"webSocketManager"),y(this,"authenticationManager"),y(this,"remoteQuerySet"),y(this,"optimisticQueryResults"),y(this,"_transitionHandlerCounter",0),y(this,"_nextRequestId"),y(this,"_onTransitionFns",new Map),y(this,"_sessionId"),y(this,"firstMessageReceived",!1),y(this,"debug"),y(this,"logger"),y(this,"maxObservedTimestamp"),y(this,"connectionStateSubscribers",new Map),y(this,"nextConnectionStateSubscriberId",0),y(this,"_lastPublishedConnectionState"),y(this,"markConnectionStateDirty",()=>{Promise.resolve().then(()=>{const h=this.connectionState();if(JSON.stringify(h)!==JSON.stringify(this._lastPublishedConnectionState)){this._lastPublishedConnectionState=h;for(const d of this.connectionStateSubscribers.values())d(h)}})}),y(this,"mark",h=>{this.debug&&ln(h,this.sessionId)}),typeof e=="object")throw new Error("Passing a ClientConfig object is no longer supported. Pass the URL of the Convex deployment as a string directly.");s?.skipConvexDeploymentUrlCheck!==!0&&ht(e),s={...s};const r=s.authRefreshTokenLeewaySeconds??2;let i=s.webSocketConstructor;if(!i&&typeof WebSocket>"u")throw new Error("No WebSocket global variable defined! To use Convex in an environment without WebSocket try the HTTP client: https://docs.convex.dev/api/classes/browser.ConvexHttpClient");i=i||WebSocket,this.debug=s.reportDebugInfoToConvex??!1,this.address=e,this.logger=s.logger===!1?ze({verbose:s.verbose??!1}):s.logger!==!0&&s.logger?s.logger:He({verbose:s.verbose??!1});const o=e.search("://");if(o===-1)throw new Error("Provided address was not an absolute URL.");const a=e.substring(o+3),u=e.substring(0,o);let c;if(u==="http")c="ws";else if(u==="https")c="wss";else throw new Error(`Unknown parent protocol ${u}`);const l=`${c}://${a}/api/${Te}/sync`;this.state=new qt,this.remoteQuerySet=new xe(h=>this.state.queryPath(h),this.logger),this.requestManager=new It(this.logger,this.markConnectionStateDirty);const f=()=>{this.webSocketManager.pause(),this.state.pause()};this.authenticationManager=new cn(this.state,{authenticate:h=>{const d=this.state.setAuth(h);return this.webSocketManager.sendMessage(d),d.baseVersion},stopSocket:()=>this.webSocketManager.stop(),tryRestartSocket:()=>this.webSocketManager.tryRestart(),pauseSocket:f,resumeSocket:()=>this.webSocketManager.resume(),clearAuth:()=>{this.clearAuth()}},{logger:this.logger,refreshTokenLeewaySeconds:r}),this.optimisticQueryResults=new Vt,this.addOnTransitionHandler(h=>{t(h.queries.map(d=>d.token))}),this._nextRequestId=0,this._sessionId=tn();const{unsavedChangesWarning:b}=s;if(typeof window>"u"||typeof window.addEventListener>"u"){if(b===!0)throw new Error("unsavedChangesWarning requested, but window.addEventListener not found! Remove {unsavedChangesWarning: true} from Convex client options.")}else b!==!1&&window.addEventListener("beforeunload",h=>{if(this.requestManager.hasIncompleteRequests()){h.preventDefault();const d="Are you sure you want to leave? Your changes may not be saved.";return(h||window.event).returnValue=d,d}});this.webSocketManager=new en(l,{onOpen:h=>{this.mark("convexWebSocketOpen"),this.webSocketManager.sendMessage({...h,type:"Connect",sessionId:this._sessionId,maxObservedTimestamp:this.maxObservedTimestamp});const d=new Set(this.remoteQuerySet.remoteQueryResults().keys());this.remoteQuerySet=new xe(ne=>this.state.queryPath(ne),this.logger);const[I,be]=this.state.restart(d);be&&this.webSocketManager.sendMessage(be),this.webSocketManager.sendMessage(I);for(const ne of this.requestManager.restart())this.webSocketManager.sendMessage(ne)},onResume:()=>{const[h,d]=this.state.resume();d&&this.webSocketManager.sendMessage(d),h&&this.webSocketManager.sendMessage(h);for(const I of this.requestManager.resume())this.webSocketManager.sendMessage(I)},onMessage:h=>{switch(this.firstMessageReceived||(this.firstMessageReceived=!0,this.mark("convexFirstMessageReceived"),this.reportMarks()),h.type){case"Transition":{this.observedTimestamp(h.endVersion.ts),this.authenticationManager.onTransition(h),this.remoteQuerySet.transition(h),this.state.transition(h);const d=this.requestManager.removeCompleted(this.remoteQuerySet.timestamp());this.notifyOnQueryResultChanges(d);break}case"MutationResponse":{h.success&&this.observedTimestamp(h.ts);const d=this.requestManager.onResponse(h);d!==null&&this.notifyOnQueryResultChanges(new Map([[d.requestId,d.result]]));break}case"ActionResponse":{this.requestManager.onResponse(h);break}case"AuthError":{this.authenticationManager.onAuthError(h);break}case"FatalError":{const d=Tt(this.logger,h.error);throw this.webSocketManager.terminate(),d}}return{hasSyncedPastLastReconnect:this.hasSyncedPastLastReconnect()}},onServerDisconnectError:s.onServerDisconnectError},i,this.logger,this.markConnectionStateDirty,this.debug),this.mark("convexClientConstructed"),s.expectAuth&&f()}hasSyncedPastLastReconnect(){return this.requestManager.hasSyncedPastLastReconnect()||this.state.hasSyncedPastLastReconnect()}observedTimestamp(e){(this.maxObservedTimestamp===void 0||this.maxObservedTimestamp.lessThanOrEqual(e))&&(this.maxObservedTimestamp=e)}getMaxObservedTimestamp(){return this.maxObservedTimestamp}notifyOnQueryResultChanges(e){const t=this.remoteQuerySet.remoteQueryResults(),s=new Map;for(const[i,o]of t){const a=this.state.queryToken(i);if(a!==null){const u={result:o,udfPath:this.state.queryPath(i),args:this.state.queryArgs(i)};s.set(a,u)}}const r=this.optimisticQueryResults.ingestQueryResultsFromServer(s,new Set(e.keys()));this.handleTransition({queries:r.map(i=>{const o=this.optimisticQueryResults.rawQueryResult(i);return{token:i,modification:{kind:"Updated",result:o}}}),reflectedMutations:Array.from(e).map(([i,o])=>({requestId:i,result:o})),timestamp:this.remoteQuerySet.timestamp()})}handleTransition(e){for(const t of this._onTransitionFns.values())t(e)}addOnTransitionHandler(e){const t=this._transitionHandlerCounter++;return this._onTransitionFns.set(t,e),()=>this._onTransitionFns.delete(t)}getCurrentAuthClaims(){const e=this.state.getAuth();let t={};if(e&&e.tokenType==="User")try{t=e?Ye(e.value):{}}catch{t={}}else return;return{token:e.value,decoded:t}}setAuth(e,t){this.authenticationManager.setConfig(e,t)}hasAuth(){return this.state.hasAuth()}setAdminAuth(e,t){const s=this.state.setAdminAuth(e,t);this.webSocketManager.sendMessage(s)}clearAuth(){const e=this.state.clearAuth();this.webSocketManager.sendMessage(e)}subscribe(e,t,s){const r=x(t),{modification:i,queryToken:o,unsubscribe:a}=this.state.subscribe(e,r,s?.journal,s?.componentPath);return i!==null&&this.webSocketManager.sendMessage(i),{queryToken:o,unsubscribe:()=>{const u=a();u&&this.webSocketManager.sendMessage(u)}}}localQueryResult(e,t){const s=x(t),r=O(e,s);return this.optimisticQueryResults.queryResult(r)}localQueryResultByToken(e){return this.optimisticQueryResults.queryResult(e)}hasLocalQueryResultByToken(e){return this.optimisticQueryResults.hasQueryResult(e)}localQueryLogs(e,t){const s=x(t),r=O(e,s);return this.optimisticQueryResults.queryLogs(r)}queryJournal(e,t){const s=x(t),r=O(e,s);return this.state.queryJournal(r)}connectionState(){const e=this.webSocketManager.connectionState();return{hasInflightRequests:this.requestManager.hasInflightRequests(),isWebSocketConnected:e.isConnected,hasEverConnected:e.hasEverConnected,connectionCount:e.connectionCount,connectionRetries:e.connectionRetries,timeOfOldestInflightRequest:this.requestManager.timeOfOldestInflightRequest(),inflightMutations:this.requestManager.inflightMutations(),inflightActions:this.requestManager.inflightActions()}}subscribeToConnectionState(e){const t=this.nextConnectionStateSubscriberId++;return this.connectionStateSubscribers.set(t,e),()=>{this.connectionStateSubscribers.delete(t)}}async mutation(e,t,s){const r=await this.mutationInternal(e,t,s);if(!r.success)throw r.errorData!==void 0?pe(r,new ge(Q("mutation",e,r))):new Error(Q("mutation",e,r));return r.value}async mutationInternal(e,t,s,r){const{mutationPromise:i}=this.enqueueMutation(e,t,s,r);return i}enqueueMutation(e,t,s,r){const i=x(t);this.tryReportLongDisconnect();const o=this.nextRequestId;if(this._nextRequestId++,s!==void 0){const l=s.optimisticUpdate;if(l!==void 0){const f=d=>{l(d,i)instanceof Promise&&this.logger.warn("Optimistic update handler returned a Promise. Optimistic updates should be synchronous.")},h=this.optimisticQueryResults.applyOptimisticUpdate(f,o).map(d=>{const I=this.localQueryResultByToken(d);return{token:d,modification:{kind:"Updated",result:I===void 0?void 0:{success:!0,value:I,logLines:[]}}}});this.handleTransition({queries:h,reflectedMutations:[],timestamp:this.remoteQuerySet.timestamp()})}}const a={type:"Mutation",requestId:o,udfPath:e,componentPath:r,args:[_(i)]},u=this.webSocketManager.sendMessage(a),c=this.requestManager.request(a,u);return{requestId:o,mutationPromise:c}}async action(e,t){const s=await this.actionInternal(e,t);if(!s.success)throw s.errorData!==void 0?pe(s,new ge(Q("action",e,s))):new Error(Q("action",e,s));return s.value}async actionInternal(e,t,s){const r=x(t),i=this.nextRequestId;this._nextRequestId++,this.tryReportLongDisconnect();const o={type:"Action",requestId:i,udfPath:e,componentPath:s,args:[_(r)]},a=this.webSocketManager.sendMessage(o);return this.requestManager.request(o,a)}async close(){return this.authenticationManager.stop(),this.webSocketManager.terminate()}get url(){return this.address}get nextRequestId(){return this._nextRequestId}get sessionId(){return this._sessionId}reportMarks(){if(this.debug){const e=fn(this.sessionId);this.webSocketManager.sendMessage({type:"Event",eventType:"ClientConnect",event:e})}}tryReportLongDisconnect(){if(!this.debug)return;const e=this.connectionState().timeOfOldestInflightRequest;if(e===null||Date.now()-e.getTime()<=60*1e3)return;const t=`${this.address}/api/debug_event`;fetch(t,{method:"POST",headers:{"Content-Type":"application/json","Convex-Client":`npm-${Te}`},body:JSON.stringify({event:"LongWebsocketDisconnect"})}).then(s=>{s.ok||this.logger.warn("Analytics request failed with response:",s.body)}).catch(s=>{this.logger.warn("Analytics response failed with error:",s)})}}function ce(n){if(typeof n!="object"||n===null||!Array.isArray(n.page)||typeof n.isDone!="boolean"||typeof n.continueCursor!="string")throw new Error(`Not a valid paginated query result: ${n?.toString()}`);return n}var mn=Object.defineProperty,wn=(n,e,t)=>e in n?mn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ee=(n,e,t)=>wn(n,typeof e!="symbol"?e+"":e,t);class Sn{constructor(e,t){this.client=e,this.onTransition=t,Ee(this,"paginatedQuerySet",new Map),Ee(this,"lastTransitionTs"),this.lastTransitionTs=v.fromNumber(0),this.client.addOnTransitionHandler(s=>this.onBaseTransition(s))}subscribe(e,t,s){const r=M(e),i=_e(r,t,s),o=()=>this.removePaginatedQuerySubscriber(i),a=this.paginatedQuerySet.get(i);return a?(a.numSubscribers+=1,{paginatedQueryToken:i,unsubscribe:o}):(this.paginatedQuerySet.set(i,{token:i,canonicalizedUdfPath:r,args:t,numSubscribers:1,options:{initialNumItems:s.initialNumItems},nextPageKey:0,pageKeys:[],pageKeyToQuery:new Map,ongoingSplits:new Map,skip:!1,id:s.id}),this.addPageToPaginatedQuery(i,null,s.initialNumItems),{paginatedQueryToken:i,unsubscribe:o})}localQueryResult(e,t,s){const r=M(e),i=_e(r,t,s);return this.localQueryResultByToken(i)}localQueryResultByToken(e){const t=this.paginatedQuerySet.get(e);if(!t)return;const s=this.activePageQueryTokens(t);if(s.length===0)return{results:[],status:"LoadingFirstPage",loadMore:u=>this.loadMoreOfPaginatedQuery(e,u)};let r=[],i=!1,o=!1;for(const u of s){const c=this.client.localQueryResultByToken(u);if(c===void 0){i=!0,o=!1;continue}const l=ce(c);r=r.concat(l.page),o=!!l.isDone}let a;return i?a=r.length===0?"LoadingFirstPage":"LoadingMore":o?a="Exhausted":a="CanLoadMore",{results:r,status:a,loadMore:u=>this.loadMoreOfPaginatedQuery(e,u)}}onBaseTransition(e){const t=e.queries.map(o=>o.token),s=this.queriesContainingTokens(t);let r=[];s.length>0&&(this.processPaginatedQuerySplits(s,o=>this.client.localQueryResultByToken(o)),r=s.map(o=>({token:o,modification:{kind:"Updated",result:this.localQueryResultByToken(o)}})));const i={...e,paginatedQueries:r};this.onTransition(i)}loadMoreOfPaginatedQuery(e,t){this.mustGetPaginatedQuery(e);const s=this.queryTokenForLastPageOfPaginatedQuery(e),r=this.client.localQueryResultByToken(s);if(!r)return!1;const i=ce(r);if(i.isDone)return!1;this.addPageToPaginatedQuery(e,i.continueCursor,t);const o={timestamp:this.lastTransitionTs,reflectedMutations:[],queries:[],paginatedQueries:[{token:e,modification:{kind:"Updated",result:this.localQueryResultByToken(e)}}]};return this.onTransition(o),!0}queriesContainingTokens(e){if(e.length===0)return[];const t=[],s=new Set(e);for(const[r,i]of this.paginatedQuerySet)for(const o of this.allQueryTokens(i))if(s.has(o)){t.push(r);break}return t}processPaginatedQuerySplits(e,t){for(const s of e){const r=this.mustGetPaginatedQuery(s),{ongoingSplits:i,pageKeyToQuery:o,pageKeys:a}=r;for(const[u,[c,l]]of i)t(o.get(c).queryToken)!==void 0&&t(o.get(l).queryToken)!==void 0&&this.completePaginatedQuerySplit(r,u,c,l);for(const u of a){if(i.has(u))continue;const c=o.get(u).queryToken,l=t(c);if(!l)continue;const f=ce(l);f.splitCursor&&(f.pageStatus==="SplitRecommended"||f.pageStatus==="SplitRequired"||f.page.length>r.options.initialNumItems*2)&&this.splitPaginatedQueryPage(r,u,f.splitCursor,f.continueCursor)}}}splitPaginatedQueryPage(e,t,s,r){const i=e.nextPageKey++,o=e.nextPageKey++,a={cursor:r,numItems:e.options.initialNumItems,id:e.id},u=this.client.subscribe(e.canonicalizedUdfPath,{...e.args,paginationOpts:{...a,cursor:null,endCursor:s}});e.pageKeyToQuery.set(i,u);const c=this.client.subscribe(e.canonicalizedUdfPath,{...e.args,paginationOpts:{...a,cursor:s,endCursor:r}});e.pageKeyToQuery.set(o,c),e.ongoingSplits.set(t,[i,o])}addPageToPaginatedQuery(e,t,s){const r=this.mustGetPaginatedQuery(e),i=r.nextPageKey++,o={cursor:t,numItems:s,id:r.id},a={...r.args,paginationOpts:o},u=this.client.subscribe(r.canonicalizedUdfPath,a);return r.pageKeys.push(i),r.pageKeyToQuery.set(i,u),u}removePaginatedQuerySubscriber(e){const t=this.paginatedQuerySet.get(e);if(t&&(t.numSubscribers-=1,!(t.numSubscribers>0))){for(const s of t.pageKeyToQuery.values())s.unsubscribe();this.paginatedQuerySet.delete(e)}}completePaginatedQuerySplit(e,t,s,r){const i=e.pageKeyToQuery.get(t);e.pageKeyToQuery.delete(t);const o=e.pageKeys.indexOf(t);e.pageKeys.splice(o,1,s,r),e.ongoingSplits.delete(t),i.unsubscribe()}activePageQueryTokens(e){return e.pageKeys.map(t=>e.pageKeyToQuery.get(t).queryToken)}allQueryTokens(e){return Array.from(e.pageKeyToQuery.values()).map(t=>t.queryToken)}queryTokenForLastPageOfPaginatedQuery(e){const t=this.mustGetPaginatedQuery(e),s=t.pageKeys[t.pageKeys.length-1];if(s===void 0)throw new Error(`No pages for paginated query ${e}`);return t.pageKeyToQuery.get(s).queryToken}mustGetPaginatedQuery(e){const t=this.paginatedQuerySet.get(e);if(!t)throw new Error("paginated query no longer exists for token "+e);return t}}function bn({getCurrentValue:n,subscribe:e}){const[t,s]=g.useState(()=>({getCurrentValue:n,subscribe:e,value:n()}));let r=t.value;return(t.getCurrentValue!==n||t.subscribe!==e)&&(r=n(),s({getCurrentValue:n,subscribe:e,value:r})),g.useEffect(()=>{let i=!1;const o=()=>{i||s(u=>{if(u.getCurrentValue!==n||u.subscribe!==e)return u;const c=n();return u.value===c?u:{...u,value:c}})},a=e(o);return o(),()=>{i=!0,a()}},[n,e]),r}var vn=Object.defineProperty,kn=(n,e,t)=>e in n?vn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,P=(n,e,t)=>kn(n,typeof e!="symbol"?e+"":e,t);const Cn=5e3;if(typeof m>"u")throw new Error("Required dependency 'react' not found");function Ze(n,e,t){function s(r){return _n(r),e.mutation(n,r,{optimisticUpdate:t})}return s.withOptimisticUpdate=function(i){if(t!==void 0)throw new Error(`Already specified optimistic update for mutation ${k(n)}`);return Ze(n,e,i)},s}class Rn{constructor(e,t){if(P(this,"address"),P(this,"cachedSync"),P(this,"cachedPaginatedQueryClient"),P(this,"listeners"),P(this,"options"),P(this,"closed",!1),P(this,"_logger"),P(this,"adminAuth"),P(this,"fakeUserIdentity"),e===void 0)throw new Error("No address provided to ConvexReactClient.\nIf trying to deploy to production, make sure to follow all the instructions found at https://docs.convex.dev/production/hosting/\nIf running locally, make sure to run `convex dev` and ensure the .env.local file is populated.");if(typeof e!="string")throw new Error(`ConvexReactClient requires a URL like 'https://happy-otter-123.convex.cloud', received something of type ${typeof e} instead.`);if(!e.includes("://"))throw new Error("Provided address was not an absolute URL.");this.address=e,this.listeners=new Map,this._logger=t?.logger===!1?ze({verbose:t?.verbose??!1}):t?.logger!==!0&&t?.logger?t.logger:He({verbose:t?.verbose??!1}),this.options={...t,logger:this._logger}}get url(){return this.address}get sync(){if(this.closed)throw new Error("ConvexReactClient has already been closed.");return this.cachedSync?this.cachedSync:(this.cachedSync=new yn(this.address,()=>{},this.options),this.adminAuth&&this.cachedSync.setAdminAuth(this.adminAuth,this.fakeUserIdentity),this.cachedPaginatedQueryClient=new Sn(this.cachedSync,e=>this.handleTransition(e)),this.cachedSync)}get paginatedQueryClient(){if(this.sync,this.cachedPaginatedQueryClient)return this.cachedPaginatedQueryClient;throw new Error("Should already be instantiated")}setAuth(e,t){if(typeof e=="string")throw new Error("Passing a string to ConvexReactClient.setAuth is no longer supported, please upgrade to passing in an async function to handle reauthentication.");this.sync.setAuth(e,t??(()=>{}))}clearAuth(){this.sync.clearAuth()}setAdminAuth(e,t){if(this.adminAuth=e,this.fakeUserIdentity=t,this.closed)throw new Error("ConvexReactClient has already been closed.");this.cachedSync&&this.sync.setAdminAuth(e,t)}watchQuery(e,...t){const[s,r]=t,i=k(e);return{onUpdate:o=>{const{queryToken:a,unsubscribe:u}=this.sync.subscribe(i,s,r),c=this.listeners.get(a);return c!==void 0?c.add(o):this.listeners.set(a,new Set([o])),()=>{if(this.closed)return;const l=this.listeners.get(a);l.delete(o),l.size===0&&this.listeners.delete(a),u()}},localQueryResult:()=>{if(this.cachedSync)return this.cachedSync.localQueryResult(i,s)},localQueryLogs:()=>{if(this.cachedSync)return this.cachedSync.localQueryLogs(i,s)},journal:()=>{if(this.cachedSync)return this.cachedSync.queryJournal(i,s)}}}prewarmQuery(e){const t=e.extendSubscriptionFor??Cn,r=this.watchQuery(e.query,e.args||{}).onUpdate(()=>{});setTimeout(r,t)}watchPaginatedQuery(e,t,s){const r=k(e);return{onUpdate:i=>{const{paginatedQueryToken:o,unsubscribe:a}=this.paginatedQueryClient.subscribe(r,t||{},s),u=this.listeners.get(o);return u!==void 0?u.add(i):this.listeners.set(o,new Set([i])),()=>{if(this.closed)return;const c=this.listeners.get(o);c.delete(i),c.size===0&&this.listeners.delete(o),a()}},localQueryResult:()=>this.paginatedQueryClient.localQueryResult(r,t,s)}}mutation(e,...t){const[s,r]=t,i=k(e);return this.sync.mutation(i,s,r)}action(e,...t){const s=k(e);return this.sync.action(s,...t)}query(e,...t){const s=this.watchQuery(e,...t),r=s.localQueryResult();return r!==void 0?Promise.resolve(r):new Promise((i,o)=>{const a=s.onUpdate(()=>{a();try{i(s.localQueryResult())}catch(u){o(u)}})})}connectionState(){return this.sync.connectionState()}subscribeToConnectionState(e){return this.sync.subscribeToConnectionState(e)}get logger(){return this._logger}async close(){if(this.closed=!0,this.listeners=new Map,this.cachedPaginatedQueryClient&&(this.cachedPaginatedQueryClient=void 0),this.cachedSync){const e=this.cachedSync;this.cachedSync=void 0,await e.close()}}handleTransition(e){const t=e.queries.map(r=>r.token),s=e.paginatedQueries.map(r=>r.token);this.transition([...t,...s])}transition(e){for(const t of e){const s=this.listeners.get(t);if(s)for(const r of s)r()}}}const we=m.createContext(void 0);function Tn(){return g.useContext(we)}const An=({client:n,children:e})=>m.createElement(we.Provider,{value:n},e);function ls(n,...e){const t=e[0]==="skip",s=e[0]==="skip"?{}:x(e[0]),r=typeof n=="string"?Ke(n):n,i=k(r),o=g.useMemo(()=>t?{}:{query:{query:r,args:s}},[JSON.stringify(_(s)),i,t]),u=In(o).query;if(u instanceof Error)throw u;return u}function ds(n){const e=typeof n=="string"?Ke(n):n,t=g.useContext(we);if(t===void 0)throw new Error("Could not find Convex client! `useMutation` must be used in the React component tree under `ConvexProvider`. Did you forget it? See https://docs.convex.dev/quick-start#set-up-convex-in-your-react-app");return g.useMemo(()=>Ze(e,t),[t,k(e)])}function _n(n){if(typeof n=="object"&&n!==null&&"bubbles"in n&&"persist"in n&&"isDefaultPrevented"in n)throw new Error("Convex function called with SyntheticEvent object. Did you use a Convex function as an event handler directly? Event handlers like onClick receive an event object as their first argument. These SyntheticEvent objects are not valid Convex values. Try wrapping the function like `const handler = () => myMutation();` and using `handler` in the event handler.")}var qn=Object.defineProperty,Pn=(n,e,t)=>e in n?qn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,he=(n,e,t)=>Pn(n,typeof e!="symbol"?e+"":e,t);class xn{constructor(e){he(this,"createWatch"),he(this,"queries"),he(this,"listeners"),this.createWatch=e,this.queries={},this.listeners=new Set}setQueries(e){for(const t of Object.keys(e)){const{query:s,args:r,paginationOptions:i}=e[t];if(k(s),this.queries[t]===void 0)this.addQuery(t,s,r,i?{paginationOptions:i}:{});else{const o=this.queries[t];(k(s)!==k(o.query)||JSON.stringify(_(r))!==JSON.stringify(_(o.args))||JSON.stringify(i)!==JSON.stringify(o.paginationOptions))&&(this.removeQuery(t),this.addQuery(t,s,r,i?{paginationOptions:i}:{}))}}for(const t of Object.keys(this.queries))e[t]===void 0&&this.removeQuery(t)}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}getLocalResults(e){const t={};for(const s of Object.keys(e)){const{query:r,args:i}=e[s],o=e[s].paginationOptions;k(r);const a=this.createWatch(r,i,o?{paginationOptions:o}:{});let u;try{u=a.localQueryResult()}catch(c){if(c instanceof Error)u=c;else throw c}t[s]=u}return t}setCreateWatch(e){this.createWatch=e;for(const t of Object.keys(this.queries)){const{query:s,args:r,watch:i,paginationOptions:o}=this.queries[t],a="journal"in i?i.journal():void 0;this.removeQuery(t),this.addQuery(t,s,r,{...a?{journal:a}:[],...o?{paginationOptions:o}:{}})}}destroy(){for(const e of Object.keys(this.queries))this.removeQuery(e);this.listeners=new Set}addQuery(e,t,s,{paginationOptions:r,journal:i}){if(this.queries[e]!==void 0)throw new Error(`Tried to add a new query with identifier ${e} when it already exists.`);const o=this.createWatch(t,s,{...i?{journal:i}:[],...r?{paginationOptions:r}:{}}),a=o.onUpdate(()=>this.notifyListeners());this.queries[e]={query:t,args:s,watch:o,unsubscribe:a,...r?{paginationOptions:r}:{}}}removeQuery(e){const t=this.queries[e];if(t===void 0)throw new Error(`No query found with identifier ${e}.`);t.unsubscribe(),delete this.queries[e]}notifyListeners(){for(const e of this.listeners)e()}}function In(n){const e=Tn();if(e===void 0)throw new Error("Could not find Convex client! `useQuery` must be used in the React component tree under `ConvexProvider`. Did you forget it? See https://docs.convex.dev/quick-start#set-up-convex-in-your-react-app");const t=g.useMemo(()=>(s,r,{journal:i,paginationOptions:o})=>o?e.watchPaginatedQuery(s,r,o):e.watchQuery(s,r,i?{journal:i}:{}),[e]);return On(n,t)}function On(n,e){const[t]=g.useState(()=>new xn(e));t.createWatch!==e&&t.setCreateWatch(e),g.useEffect(()=>()=>t.destroy(),[t]);const s=g.useMemo(()=>({getCurrentValue:()=>t.getLocalResults(n),subscribe:r=>(t.setQueries(n),t.subscribe(r))}),[t,n]);return bn(s)}const et=g.createContext(void 0);function fs(){const n=g.useContext(et);if(n===void 0)throw new Error("Could not find `ConvexProviderWithAuth` (or `ConvexProviderWithClerk` or `ConvexProviderWithAuth0`) as an ancestor component. This component may be missing, or you might have two instances of the `convex/react` module loaded in your project.");return n}function Mn({children:n,client:e,useAuth:t}){const{isLoading:s,isAuthenticated:r,fetchAccessToken:i}=t(),[o,a]=g.useState(null);return s&&o!==null&&a(null),!s&&!r&&o!==!1&&a(!1),m.createElement(et.Provider,{value:{isLoading:o===null,isAuthenticated:r&&(o??!1)}},m.createElement(En,{authProviderAuthenticated:r,fetchAccessToken:i,authProviderLoading:s,client:e,setIsConvexAuthenticated:a}),m.createElement(An,{client:e},n),m.createElement($n,{authProviderAuthenticated:r,fetchAccessToken:i,authProviderLoading:s,client:e,setIsConvexAuthenticated:a}))}function En({authProviderAuthenticated:n,fetchAccessToken:e,authProviderLoading:t,client:s,setIsConvexAuthenticated:r}){return g.useEffect(()=>{let i=!0;if(n)return s.setAuth(e,o=>{i&&r(()=>o)}),()=>{i=!1,r(o=>o?!1:null)}},[n,e,t,s,r]),null}function $n({authProviderAuthenticated:n,fetchAccessToken:e,authProviderLoading:t,client:s,setIsConvexAuthenticated:r}){return g.useEffect(()=>{if(n)return()=>{s.clearAuth(),r(()=>null)}},[n,e,t,s,r]),null}function tt(n,e){const t={get(s,r){if(typeof r=="string"){const i=[...e,r];return tt(n,i)}else if(r===Je){if(e.length<1){const i=[n,...e].join(".");throw new Error(`API path is expected to be of the form \`${n}.childComponent.functionName\`. Found: \`${i}\``)}return"_reference/childComponent/"+e.join("/")}else return}};return new Proxy({},t)}const Qn=()=>tt("components",[]),gs=$t;Qn();function Ln({children:n,client:e,useAuth:t}){const s=Vn(t);return m.createElement(Mn,{client:e,useAuth:s},n)}function Vn(n){return g.useMemo(()=>function(){const{isLoaded:t,isSignedIn:s,getToken:r,orgId:i,orgRole:o}=n(),a=g.useCallback(async({forceRefreshToken:u})=>{try{return await r({template:"convex",skipCache:u})}catch{return null}},[i,o]);return g.useMemo(()=>({isLoading:!t,isAuthenticated:s??!1,fetchAccessToken:a}),[t,s,a])},[n])}const Fn={strict_mfa:{afterMinutes:10,level:"multi_factor"},strict:{afterMinutes:10,level:"second_factor"},moderate:{afterMinutes:60,level:"second_factor"},lax:{afterMinutes:1440,level:"second_factor"}},Nn=new Set(["first_factor","second_factor","multi_factor"]),Bn=new Set(["strict_mfa","strict","moderate","lax"]),Un=n=>typeof n=="number"&&n>0,Dn=n=>Nn.has(n),jn=n=>Bn.has(n),le=n=>n.replace(/^(org:)*/,"org:"),Wn=(n,e)=>{const{orgId:t,orgRole:s,orgPermissions:r}=e;return!n.role&&!n.permission||!t||!s||!r?null:n.permission?r.includes(le(n.permission)):n.role?le(s)===le(n.role):null},$e=(n,e)=>{const{org:t,user:s}=zn(n),[r,i]=e.split(":"),o=i||r;return r==="org"?t.includes(o):r==="user"?s.includes(o):[...t,...s].includes(o)},Hn=(n,e)=>{const{features:t,plans:s}=e;return n.feature&&t?$e(t,n.feature):n.plan&&s?$e(s,n.plan):null},zn=n=>{const e=n?n.split(",").map(t=>t.trim()):[];return{org:e.filter(t=>t.split(":")[0].includes("o")).map(t=>t.split(":")[1]),user:e.filter(t=>t.split(":")[0].includes("u")).map(t=>t.split(":")[1])}},Jn=n=>{if(!n)return!1;const e=r=>typeof r=="string"?Fn[r]:r,t=typeof n=="string"&&jn(n),s=typeof n=="object"&&Dn(n.level)&&Un(n.afterMinutes);return t||s?e.bind(null,n):!1},Kn=(n,{factorVerificationAge:e})=>{if(!n.reverification||!e)return null;const t=Jn(n.reverification);if(!t)return null;const{level:s,afterMinutes:r}=t(),[i,o]=e,a=i!==-1?r>i:null,u=o!==-1?r>o:null;switch(s){case"first_factor":return a;case"second_factor":return o!==-1?u:a;case"multi_factor":return o===-1?a:a&&u}},Gn=n=>e=>{if(!n.userId)return!1;const t=Hn(e,n),s=Wn(e,n),r=Kn(e,n);return[t||s,r].some(i=>i===null)?[t||s,r].some(i=>i===!0):[t||s,r].every(i=>i===!0)},Xn=({authObject:{sessionId:n,sessionStatus:e,userId:t,actor:s,orgId:r,orgRole:i,orgSlug:o,signOut:a,getToken:u,has:c,sessionClaims:l},options:{treatPendingAsSignedOut:f=!0}})=>{if(n===void 0&&t===void 0)return{isLoaded:!1,isSignedIn:void 0,sessionId:n,sessionClaims:void 0,userId:t,actor:void 0,orgId:void 0,orgRole:void 0,orgSlug:void 0,has:void 0,signOut:a,getToken:u};if(n===null&&t===null)return{isLoaded:!0,isSignedIn:!1,sessionId:n,userId:t,sessionClaims:null,actor:null,orgId:null,orgRole:null,orgSlug:null,has:()=>!1,signOut:a,getToken:u};if(f&&e==="pending")return{isLoaded:!0,isSignedIn:!1,sessionId:null,userId:null,sessionClaims:null,actor:null,orgId:null,orgRole:null,orgSlug:null,has:()=>!1,signOut:a,getToken:u};if(n&&l&&t&&r&&i)return{isLoaded:!0,isSignedIn:!0,sessionId:n,sessionClaims:l,userId:t,actor:s||null,orgId:r,orgRole:i,orgSlug:o||null,has:c,signOut:a,getToken:u};if(n&&l&&t&&!r)return{isLoaded:!0,isSignedIn:!0,sessionId:n,sessionClaims:l,userId:t,actor:s||null,orgId:null,orgRole:null,orgSlug:null,has:c,signOut:a,getToken:u}};var X=new Error("Invariant: AsyncLocalStorage accessed in runtime where it is not available"),Yn=class{disable(){throw X}getStore(){}run(){throw X}exit(){throw X}enterWith(){throw X}};function Zn(){return new Yn}var es=Zn();function ts(n){const e=n.get.bind(n);return m.useSyncExternalStore(n.listen,e,e)}var S=(n,e)=>{e=e||n.displayName||n.name||"Component",n.displayName=e;const t=s=>{const r=ts(Ve([ye,Le],(i,o)=>i.isLoaded?o:null));return w.jsx(n,{...s,clerk:r},r?"a":"b")};return t.displayName=`withClerk(${e})`,t},F=n=>e=>{try{return m.Children.only(n)}catch{return`You've passed multiple children components to <${e}/>. You can only pass a single child component or text.`}},N=(n,e)=>(n||(n=e),typeof n=="string"&&(n=w.jsx("button",{type:"button",children:n})),n),B=n=>(...e)=>{if(n&&typeof n=="function")return n(...e)};S(({clerk:n,children:e,...t})=>{const{planId:s,planPeriod:r,for:i,onSubscriptionComplete:o,newSubscriptionRedirectUrl:a,checkoutProps:u,...c}=t;e=N(e,"Checkout");const l=F(e)("CheckoutButton"),f=()=>{if(n)return n.__internal_openCheckout({planId:s,planPeriod:r,for:i,onSubscriptionComplete:o,newSubscriptionRedirectUrl:a,...u})},h={...c,onClick:d=>(l&&typeof l=="object"&&"props"in l&&B(l.props.onClick)(d),f())};return m.cloneElement(l,h)},"CheckoutButton");S(({clerk:n,children:e,...t})=>{const{plan:s,planId:r,initialPlanPeriod:i,planDetailsProps:o,...a}=t;e=N(e,"Plan details");const u=F(e)("PlanDetailsButton"),c=()=>{if(n)return n.__internal_openPlanDetails({plan:s,planId:r,initialPlanPeriod:i,...o})},f={...a,onClick:b=>(u&&typeof u=="object"&&"props"in u&&B(u.props.onClick)(b),c())};return m.cloneElement(u,f)},"PlanDetailsButton");var ps=S(({clerk:n,children:e,...t})=>{const{signUpFallbackRedirectUrl:s,forceRedirectUrl:r,fallbackRedirectUrl:i,signUpForceRedirectUrl:o,mode:a,...u}=t;e=N(e,"Sign in");const c=F(e)("SignInButton"),l=()=>{const h={forceRedirectUrl:r,fallbackRedirectUrl:i,signUpFallbackRedirectUrl:s,signUpForceRedirectUrl:o};if(n)return a==="modal"?n.openSignIn({...h,appearance:t.appearance}):n.redirectToSignIn({...h,signInFallbackRedirectUrl:i,signInForceRedirectUrl:r})},b={...u,onClick:async h=>(c&&typeof c=="object"&&"props"in c&&await B(c.props.onClick)(h),l())};return m.cloneElement(c,b)},"SignInButton");S(({clerk:n,children:e,...t})=>{const{redirectUrl:s="/",sessionId:r,...i}=t;e=N(e,"Sign out");const o=F(e)("SignOutButton"),a=()=>n?.signOut({redirectUrl:s,sessionId:r}),c={...i,onClick:async l=>(o&&typeof o=="object"&&"props"in o&&await B(o.props.onClick)(l),a())};return m.cloneElement(o,c)},"SignOutButton");var ys=S(({clerk:n,children:e,...t})=>{const{fallbackRedirectUrl:s,forceRedirectUrl:r,signInFallbackRedirectUrl:i,signInForceRedirectUrl:o,mode:a,...u}=t;e=N(e,"Sign up");const c=F(e)("SignUpButton"),l=()=>{const h={fallbackRedirectUrl:s,forceRedirectUrl:r,signInFallbackRedirectUrl:i,signInForceRedirectUrl:o};if(n)return a==="modal"?n.openSignUp({...h,appearance:t.appearance,unsafeMetadata:t.unsafeMetadata}):n.redirectToSignUp({...h,signUpFallbackRedirectUrl:s,signUpForceRedirectUrl:r})},b={...u,onClick:async h=>(c&&typeof c=="object"&&"props"in c&&await B(c.props.onClick)(h),l())};return m.cloneElement(c,b)},"SignUpButton");S(({clerk:n,children:e,...t})=>{const{for:s,subscriptionDetailsProps:r,onSubscriptionCancel:i,...o}=t;e=N(e,"Subscription details");const a=F(e)("SubscriptionDetailsButton"),u=()=>{if(n)return n.__internal_openSubscriptionDetails({for:s,onSubscriptionCancel:i,...r})},l={...o,onClick:f=>(a&&typeof a=="object"&&"props"in a&&B(a.props.onClick)(f),u())};return m.cloneElement(a,l)},"SubscriptionDetailsButton");var Y=n=>"mount"in n,Qe=n=>"open"in n,q=class extends m.PureComponent{portalRef=m.createRef();componentDidUpdate(n){!Y(n)||!Y(this.props)||(n.props.appearance!==this.props.props.appearance||n.props?.customPages?.length!==this.props.props?.customPages?.length)&&this.props.updateProps?.({node:this.portalRef.current,props:this.props.props})}componentDidMount(){this.portalRef.current&&(Y(this.props)&&this.props.mount?.(this.portalRef.current,this.props.props),Qe(this.props)&&this.props.open?.(this.props.props))}componentWillUnmount(){this.portalRef.current&&(Y(this.props)&&this.props.unmount?.(this.portalRef.current),Qe(this.props)&&this.props.close?.())}render(){return w.jsx(w.Fragment,{children:w.jsx("div",{ref:this.portalRef})})}};S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountSignIn,unmount:n?.unmountSignIn,updateProps:n?.__unstable__updateProps,props:e}),"SignIn");S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountSignUp,unmount:n?.unmountSignUp,updateProps:n?.__unstable__updateProps,props:e}),"SignUp");var ms=S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountUserButton,unmount:n?.unmountUserButton,updateProps:n?.__unstable__updateProps,props:e}),"UserButton");S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountUserProfile,unmount:n?.unmountUserProfile,updateProps:n?.__unstable__updateProps,props:e}),"UserProfile");S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountOrganizationProfile,unmount:n?.unmountOrganizationProfile,updateProps:n?.__unstable__updateProps,props:e}),"OrganizationProfile");S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountOrganizationSwitcher,unmount:n?.unmountOrganizationSwitcher,updateProps:n?.__unstable__updateProps,props:e}),"OrganizationSwitcher");S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountOrganizationList,unmount:n?.unmountOrganizationList,updateProps:n?.__unstable__updateProps,props:e}),"OrganizationList");S(({clerk:n,...e})=>w.jsx(q,{open:n?.openGoogleOneTap,close:n?.closeGoogleOneTap,props:e}),"GoogleOneTap");S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountWaitlist,unmount:n?.unmountWaitlist,props:e}),"Waitlist");S(({clerk:n,...e})=>w.jsx(q,{mount:n?.mountPricingTable,unmount:n?.unmountPricingTable,props:e}),"PricingTable");var nt=()=>new Promise(n=>{ye.subscribe(({isLoaded:e})=>{e&&n(Le.get())})}),ns=()=>async n=>{const e=await nt();return e.session?e.session.getToken(n):null},ss=()=>async(...n)=>(await nt()).signOut(...n),Se=({treatPendingAsSignedOut:n}={})=>{const e=is(),t=g.useCallback(ns(),[]),s=g.useCallback(ss(),[]),{userId:r,orgId:i,orgRole:o,orgPermissions:a,factorVerificationAge:u,sessionClaims:c}=e,l=g.useCallback(b=>Gn({userId:r,orgId:i,orgRole:o,orgPermissions:a,factorVerificationAge:u,features:c?.fea||"",plans:c?.pla||""})(b),[r,i,o,a,u,c]),f=Xn({authObject:{...e,getToken:t,signOut:s,has:l},options:{treatPendingAsSignedOut:n}});if(!f)throw new Error("Invalid state. Feel free to submit a bug or reach out to support");return f};function rs(n,e){const t=n.get.bind(n);return g.useSyncExternalStore(n.listen,t,e||t)}function is(){const n=se.get.bind(se);return rs(se,()=>typeof window>"u"?st(!1,{user:null,session:null,organization:null},es.getStore()):n())}function ws({children:n,treatPendingAsSignedOut:e}){const{userId:t}=Se({treatPendingAsSignedOut:e});return t?null:n}function Ss({children:n,treatPendingAsSignedOut:e}){const{userId:t}=Se({treatPendingAsSignedOut:e});return t?n:null}Ve(ye,n=>n.isLoaded);S(({clerk:n,...e})=>(m.useEffect(()=>{n?.handleRedirectCallback(e)},[]),null),"AuthenticateWithRedirectCallback");const os="https://nautical-gnu-769.convex.cloud",as=new Rn(os);function bs(n){function e(t){return w.jsx(Ln,{client:as,useAuth:Se,children:w.jsx(n,{...t})})}return e}export{Rn as C,Ss as S,ms as U,gs as a,ds as b,Se as c,ws as d,ys as e,ps as f,fs as g,Gn as h,Ln as i,Xn as r,ls as u,bs as w};
